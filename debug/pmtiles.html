<!DOCTYPE html>
<html>
<head>
    <title>Mapbox GL JS debug page</title>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
    <link rel='stylesheet' href='../dist/mapbox-gl.css' />
    <style>
        body { margin: 0; padding: 0; }
        html, body, #map { height: 100%; }
        #controls { position: absolute; top: 0; left: 0; }
    </style>
</head>

<body>
<div id='map'></div>
<div id='controls'>
    <label><input id='custom-source-checkbox' type='checkbox' checked>custom source</label><br />
    <label><input id='tile-boundaries-checkbox' type='checkbox'>tile boundaries</label><br />
    <label><input id='terrain-checkbox' type='checkbox'>terrain</label><br />
</div>

<script src='../dist/mapbox-gl-dev.js'></script>
<script src='../debug/access_token_generated.js'></script>
<script src="./pmtiles-lib.js"></script>
<script src="./pmtiles-s3-loader.js"></script>
<script src="./pmtiles-sharded-source.bundle.js"></script>
<script>
    // The pmtiles library is now available as window.pmtilesLib
    window.addEventListener('load', async function() {
        console.log('=== PMTiles Loader Starting ===');

        // Check if pmtiles is available
        if (!window.pmtilesLib) {
            console.error('PMTiles library not loaded');
            return;
        }

        console.log('‚úì PMTiles library loaded', typeof window.pmtilesLib);

        // Check URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        let s3Path = urlParams.get('s3'); // Format: s3://bucket-name/path/{z}/{x}/{y}
        const tilesetId = urlParams.get('tilesetId');
        const jobId = urlParams.get('jobId');
        const shardingConfig = urlParams.get('sharding') || 'v1'; // Sharding config version
        const httpUrl = urlParams.get('pmtiles'); // Format: https://...

        // If tilesetId and jobId are provided, construct the S3 path
        if (tilesetId && jobId && !s3Path) {
            s3Path = `s3://tilestream-tilesets-staging/pmtiles/${tilesetId}/${jobId}/{z}/{x}/{y}`;
            console.log('Constructed S3 path from tilesetId and jobId:', s3Path);
        }

        console.log('URL Parameters:', {
            tilesetId,
            jobId,
            s3Path,
            shardingConfig,
            httpUrl
        });

        // S3 Proxy URL (run: node debug/s3-proxy.cjs)
        const S3_PROXY_URL = 'http://127.0.0.1:9968';
        console.log('S3 Proxy URL:', S3_PROXY_URL);

        // Initialize PMTiles
        let pmtiles;

        console.log('Initializing PMTiles source...');
        if (s3Path && s3Path.includes('{z}')) {
            console.log('‚Üí Using sharded PMTiles from S3:', s3Path);
            pmtiles = new ShardedPMTiles.ShardedPMTilesSource({
                baseUrl: s3Path,
                shardingConfig,
                proxyUrl: S3_PROXY_URL
            });
        } else if (s3Path) {
            console.log('‚Üí Using single PMTiles file from S3:', s3Path);
            const s3Source = new S3ProxySource(s3Path, S3_PROXY_URL);
            pmtiles = new window.pmtilesLib.PMTiles(s3Source);
        } else if (httpUrl) {
            console.log('‚Üí Using HTTP URL:', httpUrl);
            pmtiles = new window.pmtilesLib.PMTiles(httpUrl);
        } else {
            console.log('‚Üí Using local file: /debug/firenze.pmtiles');
            pmtiles = new window.pmtilesLib.PMTiles('/debug/firenze.pmtiles');
        }

        // Store globally for debugging
        window.pmtiles = pmtiles;

        console.log('Fetching PMTiles header...');
        const header = await pmtiles.getHeader();
        console.log('‚úì PMTiles header loaded:', {
            centerLon: header.centerLon,
            centerLat: header.centerLat,
            maxZoom: header.maxZoom
        });

        const map = window.map = new mapboxgl.Map({
            container: 'map',
            center: [header.centerLon, header.centerLat],
            zoom: header.maxZoom - 2,
            style: 'mapbox://styles/mapbox/light-v10',
            hash: true
        });

        map.addControl(new mapboxgl.NavigationControl());

        console.log('Initializing Mapbox GL map...');

        map.on('load', () => {
            console.log('‚úì Map loaded, adding PMTiles source...');

            map.addSource('firenze', {
                type: 'vector',
                maxzoom: header.maxZoom,
                async loadTile({z, x, y}, {signal}) {
                    console.log(`üó∫Ô∏è  Loading tile: ${z}/${x}/${y}`);

                    // If using sharded source, log which shard this tile maps to
                    if (pmtiles.shardingScheme) {
                        const [shardZ, shardX, shardY] = pmtiles.shardingScheme.getShardZXY(z, x, y);
                        console.log(`   ‚Üí Mapped to shard: ${shardZ}/${shardX}/${shardY}`);
                    }

                    const response = await pmtiles.getZxy(z, x, y, signal);
                    if (!response) {
                        console.warn(`‚ö†Ô∏è  No data for tile ${z}/${x}/${y}`);
                        return null;
                    }
                    const dataSize = response.data.byteLength || response.data.length;
                    console.log(`‚úì Tile loaded: ${z}/${x}/${y}, size: ${dataSize} bytes`);
                    return response.data;
                }
            });

            map.addLayer({
                id: 'firenze-landuse',
                type: 'fill',
                source: 'firenze',
                'source-layer': 'landuse',
                paint: {
                    'fill-color': 'steelblue'
                }
            }, 'road-label');

            map.addLayer({
                id: 'roads',
                type: 'line',
                source: 'firenze',
                'source-layer': 'roads',
            }, 'road-label');

            map.addSource('mapbox-dem', {
                type: 'raster-dem',
                url: 'mapbox://mapbox.mapbox-terrain-dem-v1',
                tileSize: 512
            });

            document.getElementById('terrain-checkbox').onclick = function () {
                map.setTerrain(this.checked ? {source: 'mapbox-dem'} : null);
            };

            document.getElementById('tile-boundaries-checkbox').onclick = function () {
                map.showTileBoundaries = this.checked;
            };

            document.getElementById('custom-source-checkbox').onclick = function () {
                map.setLayoutProperty('custom-source', 'visibility', this.checked ? 'visible' : 'none');
            };
        });

    }); // End load event listener
</script>
</body>
</html>
