<!DOCTYPE html>
<html>

<head>
    <title>Mapbox GL JS Sky Demo</title>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link href='main.css' rel='stylesheet' type="text/css" />
    <style>
        body {
            margin: 0;
            padding: 0
        }

        html,
        body,
        #map {
            height: 100%;
        }

        #inputs {
            position: absolute;
            top: 0;
            left: 0;
            padding: 10px;
        }
    </style>
</head>
<body>
    <script src='../dist/mapbox-gl-dev.js'></script>
    <script src='../debug/access_token_generated.js'></script>
    <div id='map'></div>
    <div id='inputs'>
        <label>Local Time and date</label>
        <input type="datetime-local" id="sky-date-time" name="sky-date-time">
        <input type="button" id="sunriseEnd" value="sunrise">
        <input type="button" id="goldenHourEnd" value="morning">
        <input type="button" id="solarNoon" value="afternoon">
        <input type="button" id="goldenHour" value="evening">
        <input type="button" id="sunsetStart" value="sunset">
    </div>
    <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.8.0/suncalc.min.js'></script>
    <script>
        var map = window.map = new mapboxgl.Map({
            container: 'map',
            zoom: 14.1,
            center: [-114.34411, 32.6141],
            pitch: 85,
            bearing: 70,
            style: 'mapbox://styles/mapbox/satellite-v9',
            hash: true,
        });

        const sunTimeLabels = [ 'sunriseEnd', 'goldenHourEnd', 'solarNoon', 'goldenHour', 'sunsetStart'];
        const element = document.getElementById('sky-date-time');
        let sunTimes = [];

        initialize();

        map.on('style.load', function () {
            getSunTimes();

            map.addSource('mapbox-dem', {
                "type": "raster-dem",
                "url": "mapbox://mapbox.terrain-rgb",
                "tileSize": 512,
                "maxzoom": 14
            });

            map.setTerrain({"source": "mapbox-dem", "exaggeration": 1.5});

            map.addLayer({
                'id': 'sky',
                'type': 'sky',
                'paint': {
                    'sky-opacity': ['interpolate', ['linear'],
                        ['zoom'],
                        0, 0,
                        5, 0.3,
                        8, 1],
                    'sky-type': 'atmosphere',
                    'sky-atmosphere-sun': getSunPosition(Date.now()),
                    'sky-atmosphere-sun-intensity': 5,
                }
            });

            element.addEventListener('change', updateSunPosition);
        });
        map.on('moveend', () => {
            getSunTimes();
            updateSunPosition();
        });

        function initialize() {
            //Set local time
            element.valueAsNumber = Date.now() - (new Date()).getTimezoneOffset() * 60000;

            sunTimeLabels.forEach((btnId) => {
                document.getElementById(btnId).addEventListener('click', updateSunPosition);
            });
        }

        function updateSunPosition() {
            const btnId = this.id;
            let sunTime = sunTimes[btnId];
            if (sunTime) {
                //When called from button click handler, update datetime input field
                element.valueAsNumber = sunTime - (new Date()).getTimezoneOffset() * 60000;
            } else {
                sunTime = new Date(element.valueAsNumber + (new Date()).getTimezoneOffset() * 60000);
            }
            var sunPos = getSunPosition(sunTime);
            map.setPaintProperty('sky', 'sky-atmosphere-sun', sunPos);
        }

        function getSunTimes() {
            const sunLightDate = new Date(element.valueAsNumber);
            const center = map.getCenter();
            // eslint-disable-next-line no-undef
            sunTimes = SunCalc.getTimes(sunLightDate, center.lat, center.lng);
        }

        function getSunPosition(newDateTime) {
            const center = map.getCenter();
            // eslint-disable-next-line no-undef
            var sunPos = SunCalc.getPosition(newDateTime, center.lat, center.lng);
            var sunAzimuth = 180 + sunPos.azimuth * 180 / Math.PI;
            var sunAltitude = 90 - sunPos.altitude * 180 / Math.PI;
            return [sunAzimuth, sunAltitude];
        }

    </script>
</body>

</html>