<!DOCTYPE html>
<html>

<head>
    <title>Mapbox GL JS debug page</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="../dist/mapbox-gl.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        html,
        body,
        #map {
            height: 100%;
        }

        #radius {
            position: absolute;
            width: 700px;
            top: 10px;
            left: 10px;
            z-index: 1000;
        }

        .tp-dfwv {
            position: absolute;
            left: 10px;
            top: 10px;
            z-index: 1000;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script type="module">
        // This page uses the esm build of Mapbox GL JS,
        // so need to run 'npm run start-esm' to serve it.
        import mapbox from '../dist/esm-dev/mapbox-gl.js';
        import {Pane} from 'https://cdn.jsdelivr.net/npm/tweakpane@4.0.5/dist/tweakpane.min.js';
        import {getAccessToken} from './access_token_generated.js';
    
        mapbox.accessToken = getAccessToken();

        var map = window.map = new mapbox.Map({
            container: 'map',
            devtools: true,
            zoom: 18,
            center: [11.576073, 48.135578],
            pitch: 54,
            bearing: -55.2,
            style: 'mapbox://styles/mapbox-map-design/standard-rc',
            config: {
                basemap: {
                    show3dFacades: true
                }
            },
            hash: true
        });

        const buildingDebugPane = new Pane();
        buildingDebugPane.title = "Procedural Buildings";

        var params = {
            ambientColor: [255, 255, 255],
            ambientIntensity: 0.5,
            sunColor: [255, 255, 255],
            sunIntensity: 0.5,
            sunBearing: 160,
            sunPolarAngle: 50,
            castShadows: true,
            shadowIntensity: 1.0,
            lightPreset: "day",
            show3dObjects: true,
            show3dBuildings: true,
            show3dFacades: true,
            show3dLandmarks: true
        };

        const lightFolder = buildingDebugPane.addFolder({
            title: 'Sun',
            expanded: true,
        });

        lightFolder.addBinding(params, "sunBearing", { label: "Bearing Angle", min: 0, max: 360 }).on('change', function (ev) {
            updateSunLight();
        });

        lightFolder.addBinding(params, "sunPolarAngle", { label: "Polar Angle", min: 0, max: 90 }).on('change', function (ev) {
            updateSunLight();
        });

        const buildingFolder = buildingDebugPane.addFolder({
            title: 'Buildings',
            expanded: true,
        });

        buildingFolder.addBinding(params, "show3dObjects", { label: "Show 3D Objects" }).on('change', function (ev) {
            map.setConfigProperty("basemap", "show3dObjects", params.show3dObjects);
        });

        buildingFolder.addBinding(params, "show3dBuildings", { label: "Show 3D Buildings" }).on('change', function (ev) {
            map.setConfigProperty("basemap", "show3dBuildings", params.show3dBuildings);
        });

        buildingFolder.addBinding(params, "show3dLandmarks", { label: "Show 3D Landmarks" }).on('change', function (ev) {
            map.setConfigProperty("basemap", "show3dLandmarks", params.show3dLandmarks);
        });
        
        buildingFolder.addBinding(params, "show3dFacades", { label: "Show 3D Facades" }).on('change', function (ev) {
            map.setConfigProperty("basemap", "show3dFacades", params.show3dFacades);
        });

        function updateSunLight() {
            map.setLights([
                {
                    'type': 'ambient',
                    'id': 'ambient_light',
                    'properties': {
                        'color': `rgba(${params.ambientColor[0]}, ${params.ambientColor[1]}, ${params.ambientColor[2]}, 1.0)`,
                        'intensity': params.ambientIntensity
                    }
                },
                {
                    'type': 'directional',
                    'id': 'directional_light',
                    'properties': {
                        'color': `rgba(${params.sunColor[0]}, ${params.sunColor[1]}, ${params.sunColor[2]}, 1.0)`,
                        'intensity': params.sunIntensity,
                        'direction': [
                        params.sunBearing,
                        params.sunPolarAngle
                        ],
                        'cast-shadows': params.castShadows,
                        'shadow-intensity': params.shadowIntensity
                    }
                }
            ]);
            map.triggerRepaint();
        };

        map.on('style.load', () => {
            // Store the original style so we can restore it - e.g. if someone
            // changed the lighting using one of the other debug options.
            let styleLights = map.getLights();
            
            lightFolder.addBinding(params, "lightPreset", {
                label: "Light Preset",
                options: {
                    Dawn: "dawn",
                    Day: "day",
                    Dusk: "dusk",
                    Night: "night",
                }
            }, () => {
            }).on('change', function (ev) {
                map.setLights(styleLights);
                map.setConfigProperty("basemap", "lightPreset", params.lightPreset);
            });
        });

        let selectedBuilding = null;
        map.addInteraction('place-click', {
            type: 'click',
            target: { featuresetId: 'buildings', importId: 'basemap' },
            handler: ({ feature }) => {
                console.log(feature.id);

                if (selectedBuilding) {
                    map.setFeatureState(selectedBuilding, {select: false});
                }
                map.setFeatureState(feature, {select: !feature.state.select});
                selectedBuilding = feature;
            }
        });
    </script>
</body>

</html>
